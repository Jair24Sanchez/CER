<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realizar reportaje - CER</title>
    <link rel="stylesheet" href="./report-events.css">
    <link rel="stylesheet" href="./blog-editor.css">
</head>
<body>
    <!-- Modal CREATE -->
    <div id="createModal" class="modal-create">
        <div class="modal-create-content">
            <img src="./cer_blanco.png" alt="CER Logo" class="modal-create-logo">
            <div class="modal-create-title"><em>CREATE</em></div>
            <a href="./report-events.html" class="modal-create-btn">Reports</a>
            <a href="./organize.html" class="modal-create-btn">Organize</a>
        </div>
    </div>
    <!-- Modal LOGIN -->
    <div id="loginModal" class="modal-create" style="display:none;">
        <div class="modal-create-content" style="height:auto; min-height:auto; gap:12px;">
            <img src="./cer_blanco.png" alt="CER Logo" class="modal-create-logo" style="margin-bottom:0;">
            <div class="modal-create-title" style="margin:0;">LOGIN</div>
            <input id="loginEmail" type="email" placeholder="Email" class="filter-select" style="width: 90%;">
            <input id="loginPassword" type="password" placeholder="Password" class="filter-select" style="width: 90%;">
            <button id="loginSubmit" class="modal-create-btn" style="background:#000;">Entrar</button>
            <div style="margin:8px 0; font-weight:600;">o</div>
            <button id="googleLoginBtn" class="modal-create-btn google-btn">Continuar con Google</button>
            <div style="margin:8px 0; font-weight:600;">o conecta una wallet</div>
            <div class="wallet-grid">
                <button id="metamaskBtn" class="modal-create-btn">MetaMask</button>
                <button id="coinbaseBtn" class="modal-create-btn">Coinbase Wallet</button>
                <button id="rabbyBtn" class="modal-create-btn">Rabby</button>
                <button id="walletConnectBtn" class="modal-create-btn">WalletConnect</button>
            </div>
        </div>
    </div>
    <header class="main-header">
        <a href="./Homepage.html" class="logo-link">
            <img src="./cer-logo.png" alt="CER Logo" class="logo">
        </a>
        <div class="header-buttons">
            <button class="create-btn">CREATE</button>
            <button class="login-btn">LOGIN</button>
        </div>
    </header>

    <main class="blog-editor">
        <div class="blog-container">
            <!-- TÃ­tulo del blog (bloqueado) -->
            <input type="text" class="blog-title" id="lockedTitle" placeholder="TÃ­tulo del evento" disabled style="background: #f5f5f5;">

            <div class="blog-meta">
                <!-- SecciÃ³n de etiquetas -->
                <div class="tag-section">
                    <button class="tag-profile-btn">
                        <div class="profile-preview">
                            <div class="profile-image"></div>
                            <div class="profile-name"></div>
                        </div>
                    </button>
                    <div class="selected-tags">
                        <span class="tag-badge" id="tagTypeLabel" style="display:none;"></span>
                        <span class="tag-badge" id="tagSubtypeLabel" style="display:none;"></span>
                    </div>
                </div>

                <!-- Filtros (bloqueados) -->
                <div class="filters" style="display:none;">
                    <select id="eventType" class="filter-select" disabled style="background: #f5f5f5;">
                        <option value="irl">IRL Events</option>
                        <option value="digital">Digital Events</option>
                    </select>
                    <select id="secondaryFilter" class="filter-select" disabled style="background: #f5f5f5;">
                        <!-- Se llenarÃ¡ dinÃ¡micamente con JavaScript -->
                    </select>
                </div>
            </div>

            <!-- UbicaciÃ³n bloqueada -->
                <div class="filters" style="margin-bottom: 1.5rem;">
                <input id="lockedLocation" class="filter-select" placeholder="UbicaciÃ³n" disabled style="background: #f5f5f5;">
            </div>

            <!-- Herramientas de ediciÃ³n -->
            <div class="editor-tools">
                <button class="tool-btn" data-tool="bold"><strong>B</strong></button>
                <button class="tool-btn" data-tool="italic"><em>K</em></button>
                <button class="tool-btn" data-tool="underline"><u>U</u></button>
                <button class="tool-btn" data-tool="increase-font">A<span class="arrow-up">â†‘</span></button>
                <button class="tool-btn" data-tool="decrease-font">A<span class="arrow-down">â†“</span></button>
                <label class="tool-btn image-upload">
                    <input type="file" accept=".jpg,.png" hidden>
                    <span>ðŸ“·</span>
                </label>
            </div>

            <!-- Ãrea de contenido -->
            <div class="blog-content" contenteditable="true" placeholder="Escribe sobre tu reportaje aquÃ­..."></div>

            <!-- BotÃ³n de envÃ­o -->
            <button class="submit-btn" id="submitReportBtn">Enviar</button>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="./js/web3-contract.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/countries-list.js"></script>
    <script src="./js/languages-list.js"></script>
    <script src="./js/blog-editor.js"></script>
    <script src="./js/modal-create.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="./js/login.js"></script>
    <script>
    (function(){
        // Cargar evento bloqueado por id
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const events = JSON.parse(localStorage.getItem('requestedEvents')||'[]');
        const ev = events.find(e=>e.id===id);
        if(!ev){
            alert('No se encontrÃ³ el evento.');
            window.location.href = './report-events.html';
            return;
        }
        
        // Rellenar y bloquear meta
        document.getElementById('lockedTitle').value = ev.title;
        const typeSel = document.getElementById('eventType');
        const subSel = document.getElementById('secondaryFilter');
        typeSel.value = ev.type;
        
        // poblar subtipos
        const list = ev.type==='irl'?window.countriesList:window.languagesList;
        subSel.innerHTML = '';
        list.forEach(opt=>{
            const o=document.createElement('option');
            o.value = opt.code.toLowerCase();
            o.textContent = opt.name;
            subSel.appendChild(o);
        });
        subSel.value = ev.subtype.toLowerCase();
        document.getElementById('lockedLocation').value = ev.location;

        // Mostrar badges con datos del evento bloqueado
        (function(){
            const typeBadge = document.getElementById('tagTypeLabel');
            const subtypeBadge = document.getElementById('tagSubtypeLabel');
            if(typeBadge){ typeBadge.textContent = ev.typeLabel; typeBadge.style.display='inline-block'; }
            if(subtypeBadge){ subtypeBadge.textContent = ev.subtypeLabel; subtypeBadge.style.display='inline-block'; }
        })();

        // Obtener sesiÃ³n actual para identificar al autor
        const session = JSON.parse(localStorage.getItem('session')||'null');
        const authorName = session?.email ? session.email : (session?.provider ? session.provider : 'reporter');
        const authorId = session?.email || session?.provider || 'anon';

        // Si ya enviÃ³ un reportaje para este request, bloquear reenvÃ­o
        (function(){
            const completed = JSON.parse(localStorage.getItem('completedReports')||'[]');
            const already = completed.some(r => r.requestId === ev.id && r.authorId === authorId);
            if (already) {
                const btn = document.getElementById('submitReportBtn');
                if (btn) { btn.disabled = true; btn.textContent = 'Ya enviado'; }
            }
        })();

        // EnvÃ­o: guardar como reportaje realizado y vincular al evento
        document.getElementById('submitReportBtn').addEventListener('click', function(){
            const content = document.querySelector('.blog-content').innerHTML.trim();
            if(!content){
                alert('Escribe el contenido del reportaje.');
                return;
            }
            const btn = document.getElementById('submitReportBtn');
            if (btn && btn.disabled) { return; }
            const completed = JSON.parse(localStorage.getItem('completedReports')||'[]');
            // Evitar duplicados por seguridad
            if (completed.some(r => r.requestId === ev.id && r.authorId === authorId)) {
                alert('Este reportaje ya fue enviado por tu usuario.');
                if (btn) { btn.disabled = true; btn.textContent = 'Ya enviado'; }
                return;
            }
            const report = {
                id: Date.now().toString(),
                requestId: ev.id,
                title: ev.title,
                content,
                type: ev.type,
                subtype: ev.subtype,
                typeLabel: ev.typeLabel,
                subtypeLabel: ev.subtypeLabel,
                author: authorName,
                authorId: authorId,
                rewardType: ev.rewardType,
                rewardAmount: ev.rewardAmount,
                createdAt: new Date().toISOString()
            };
            completed.push(report);
            localStorage.setItem('completedReports', JSON.stringify(completed));

            // actualizar estado del requestedEvent a 'espera' o 'edicion'
            ev.status = 'espera';
            localStorage.setItem('requestedEvents', JSON.stringify(events));

            // Redirigir a organize con ancla a review
            window.location.href = './organize.html#review';
        });
    })();
    </script>
</body>
</html>


